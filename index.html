<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>智能锁控制器 v2.5.4 + Locktober AI (完整版)</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#00FF88">

<style>
:root{
  --bg1:#06070a; --bg2:#0f1116; --card:#0f1214;
  --accent:#00ff88; --accent-2:#38d04b; --muted:#9aa0a6;
  --glass: rgba(255,255,255,0.03);
  --danger:#ff6b6b; --ease:cubic-bezier(.4,0,.2,1);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(160deg,var(--bg1),var(--bg2));font-family:"Segoe UI",Inter,Roboto,Arial;color:#fff;-webkit-font-smoothing:antialiased}
.app{max-width:980px;margin:18px auto;padding:14px;display:grid;grid-template-columns:360px 1fr;gap:18px}
@media(max-width:820px){.app{grid-template-columns:1fr;padding:10px}}

.card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;padding:12px;box-shadow:0 14px 40px rgba(0,0,0,0.6)}
.left{display:flex;flex-direction:column;align-items:center;gap:12px}
.circle{width:260px;height:260px;border-radius:50%;position:relative;display:flex;align-items:center;justify-content:center;background:conic-gradient(var(--accent-2) 0deg,#2a2a30 0deg);transition:background .45s var(--ease),transform .18s var(--ease);box-shadow:0 20px 40px rgba(0,0,0,0.6);cursor:pointer;overflow:visible}
.circle::before{content:"";position:absolute;width:200px;height:200px;border-radius:50%;background:radial-gradient(circle at top,#0b0b0b,#101218);box-shadow:inset 0 6px 14px rgba(0,0,0,0.6)}
.circle-inner{position:absolute;width:170px;text-align:center;z-index:2}
.circle-title{font-size:20px;font-weight:700}
.circle-sub{font-size:13px;color:var(--muted);margin-top:6px}

.circle.flash-success{animation:flashSuccess 1.6s both}
@keyframes flashSuccess{0%{transform:scale(1)}25%{transform:scale(1.03);box-shadow:0 0 26px rgba(124,243,124,0.35)}60%{transform:scale(1.02);box-shadow:0 0 18px rgba(124,243,124,0.25)}100%{transform:scale(1)}}
.circle.flash-fail{animation:flashFail 1.6s both}
@keyframes flashFail{0%{transform:scale(1)}25%{transform:scale(1.03);box-shadow:0 0 26px rgba(255,107,107,0.35)}60%{transform:scale(1.02);box-shadow:0 0 18px rgba(255,107,107,0.25)}100%{transform:scale(1)}}

.controls{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
.btn{border:0;padding:10px 14px;border-radius:10px;background:linear-gradient(180deg,var(--accent),#28b64a);color:#002;font-weight:800;cursor:pointer;box-shadow:0 8px 18px rgba(0,0,0,0.45)}
.btn.ghost{background:transparent;color:#fff;border:1px solid rgba(255,255,255,0.06)}
.btn.small{padding:8px 10px;font-size:13px}
.btn:disabled {opacity: 0.5; cursor: not-allowed;}

.right{display:flex;flex-direction:column;gap:10px}
.hdr-row{display:flex;justify-content:space-between;align-items:center;gap:12px}
h1{margin:0;color:var(--accent);font-size:18px}
.meta{color:var(--muted);font-size:13px}
.stats{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
.stat{background:var(--glass);padding:8px;border-radius:10px;min-width:110px}
.stat .label{font-size:12px;color:var(--muted)}
.stat .val{font-weight:700;margin-top:6px}
#log{margin-top:8px;padding:12px;border-radius:10px;background:rgba(0,0,0,0.25);max-height:420px;overflow:auto;font-size:13px;color:#dfeff0;white-space:pre-wrap}

.modal-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);backdrop-filter: blur(6px);z-index:80}
.modal{width:92%;max-width:520px;background:linear-gradient(180deg,#0f1115,#0b0c10);border-radius:12px;padding:14px;box-shadow:0 20px 50px rgba(0,0,0,0.7);transform:scale(.96);opacity:0;transition:transform .28s var(--ease),opacity .28s var(--ease)}
.modal.show{transform:scale(1);opacity:1}
.modal h3{margin:0;color:var(--accent);font-size:18px}
.modal p.lead{color:var(--muted);margin:8px 0 12px 0;font-size:13px}

.selector{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:8px}
.sel-block{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:8px;border-radius:10px;min-width:90px;text-align:center;border:1px solid rgba(255,255,255,0.03)}
.sel-num{font-size:20px;font-weight:800}
.icon-btn{background:transparent;border:1px solid rgba(255,255,255,0.04);border-radius:8px;padding:6px 10px;color:var(--muted);cursor:pointer}
.icon-btn:active{transform:translateY(1px)}

.calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:8px}
.cal-day{height:40px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700}
.cal-day.disabled{color:rgba(255,255,255,0.12)}
.cal-day.today{border:1px solid rgba(124,243,124,0.12)}
.cal-day.selected{background:linear-gradient(180deg,var(--accent),#28b64a);color:#001}

.foot{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff;padding:8px 12px;border-radius:8px}
.primary{background:linear-gradient(180deg,var(--accent),#28b64a);padding:8px 12px;border-radius:8px;color:#001;font-weight:800}

.toast{position:fixed;left:50%;top:14%;transform:translateX(-50%);background:rgba(0,0,0,0.9);padding:12px 18px;border-radius:10px;z-index:200;display:none;transition:all .3s var(--ease)}
.toast.show{display:block;animation:pop .3s var(--ease)}
@keyframes pop{from{transform:translate(-50%,-10px);opacity:0}to{transform:translate(-50%,0);opacity:1}}
.toast.error{background:rgba(255,107,107,0.85); color:#ffe; font-weight: 700;}
.toast .muted{color:inherit; opacity: 0.8;}
.muted{color:var(--muted);font-size:13px}

/* === Locktober AI 浮窗样式 === */
#aiFloatBtn {
  position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px;
  background: linear-gradient(135deg, #ff2e63, #ff4d8d); color: #fff;
  border: none; border-radius: 50%; font-size: 28px; font-weight: bold;
  box-shadow: 0 6px 20px rgba(255,46,99,0.5); cursor: pointer; z-index: 1000;
  animation: pulse 2s infinite;
}
@keyframes pulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.1); } }

#aiChatPanel {
  position: fixed; bottom: 90px; right: 20px; width: 340px; height: 520px;
  background: #111118; border: 1px solid #333; border-radius: 16px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.7); z-index: 999; display: none;
  flex-direction: column; font-size: 14px;
}
#aiChatPanel.dragging { opacity: 0.9; }
#aiHeader {
  padding: 12px; background: linear-gradient(135deg, #ff2e63, #ff4d8d); color: #fff;
  font-weight: 600; display: flex; justify-content: space-between; align-items: center;
  border-radius: 16px 16px 0 0; cursor: move;
}
#aiMessages { flex: 1; overflow-y: auto; padding: 12px; display: flex; flex-direction: column; gap: 10px; }
.ai-msg { max-width: 85%; padding: 9px 12px; border-radius: 14px; font-size: 13.5px; line-height: 1.5; word-break: break-word; }
.ai-msg.user { align-self: flex-end; background: #ff4d8d; color: #fff; border-bottom-right-radius: 4px; }
.ai-msg.ai { align-self: flex-start; background: #1a1a22; color: #ddd; border: 1px solid #333; border-bottom-left-radius: 4px; }
#aiInputBox { display: flex; padding: 10px; background: #0a0a0f; border-top: 1px solid #222; gap: 8px; }
#aiInput { flex: 1; padding: 10px; background: #1a1a22; border: 1px solid #333; border-radius: 10px; color: #fff; font-size: 14px; outline:none; }
#aiSendBtn { padding: 0 16px; background: #ff2e63; border: none; border-radius: 10px; color: #fff; cursor: pointer; }
#aiTags { text-align: center; padding: 6px; font-size: 11px; color: #ff6b9d; font-family: monospace; }
</style>
</head>
<body>

<div class="app">
  <div class="card left">
    <div id="lockCircle" class="circle" title="点击上锁/查看（隐藏模式）">
      <div class="circle-inner">
        <div id="circleTitle" class="circle-title">未上锁</div>
        <div id="circleSub" class="circle-sub">点击上锁</div>
      </div>
    </div>

    <div class="controls">
      <button id="connectBtn" class="btn small">连接设备</button>
      <button id="timerBtn" class="btn small">设置定时</button>
      <button id="lotteryBtn" class="btn small">抽奖</button>
      <button id="batteryBtn" class="btn small ghost">查电量</button>
    </div>

    <div class="controls" style="margin-top: 6px;">
      <button id="midUnlockBtn" class="btn small" style="display:none; background:#ff8c42">中途解锁</button>
    </div>

    <div style="display:flex;gap:8px;justify-content:center;margin-top:6px">
      <button id="guessBtn" class="ghost small" style="display:none">猜剩余时间</button>
    </div>

    <div style="text-align:center;margin-top:8px">
      <div class="muted">目标结束：<span id="targetTime">-</span></div>
      <div class="muted">剩余：<strong id="remainingText">-</strong></div>
    </div>
  </div>

  <div class="card right">
    <div class="hdr-row">
      <div>
        <h1>智能锁 · v2.5.4 Web BLE</h1>
        <div class="meta" style="color:#f99">需 HTTPS/localhost, 兼容 Chrome/Edge</div>
      </div>
    </div>

    <div class="stats" style="margin-top:12px">
      <div class="stat"><div class="label">连接</div><div id="connStatus" class="val">未连接</div></div>
      <div class="stat"><div class="label">锁定</div><div id="lockStatusDisplay" class="val">未上锁</div></div>
      <div class="stat"><div class="label">电量</div><div id="countShort" class="val">—</div></div>
    </div>

    <div id="log">日志区（Web BLE 交互）\n</div>
  </div>
</div>

<!-- 模态框 -->
<div id="timerModal" class="modal-overlay">...</div>
<div id="lotteryModal" class="modal-overlay">...</div>
<div id="viewModal" class="modal-overlay">...</div>
<div id="guessModal" class="modal-overlay">...</div>
<div id="guessToast" class="toast"></div>

<!-- AI 浮窗 -->
<button id="aiFloatBtn">AI</button>
<div id="aiChatPanel">
  <div id="aiHeader">
    <div>Locktober AI · 第 <span id="lockDay">0</span> 天</div>
    <button id="closeAIPanel" style="background:none;border:none;color:#fff;font-size:18px;cursor:pointer;">×</button>
  </div>
  <div id="aiMessages"></div>
  <div id="aiInputBox">
    <input id="aiInput" placeholder="主人想说什么？" />
    <button id="aiSendBtn">发送</button>
  </div>
  <div id="aiTags">#none</div>
</div>

<script src="https://js.puter.com/v2/"></script>
<script>
/* ---------- 常量 & 状态 ---------- */
const WORKER_API_URL = 'https://wispy-forest-3d27.jdjdjduisk.workers.dev/';
const MAX_SECONDS = 90 * 24 * 3600;
const MIN_SECONDS = 60;

let connected = false, total = 0, remaining = 0, timerId = null, targetEnd = null;
let hideMode = false, viewUsed = false, batteryLevel = 85;
let lockStatus = 'unlocked';
let maxUnlockCount = 0, usedUnlockCount = 0, intervalDays = 0, lastUnlockTime = 0;
let lockStartTime = 0;

let localStart = 0, remoteTarget = 0;
let timeOffset = 0;

/* BLE UUIDs */
const SERVICE_UUID = '00008ac0-0000-1000-8000-00805f9b34fb';
const WRITE_CHAR_UUID = '00008ac1-0000-1000-8000-00805f9b34fb';

/* DOM */
const $ = id => document.getElementById(id);
const midUnlockBtn = $('midUnlockBtn');

/* 日志 */
function log(msg){ const area = $('log'); const ts = new Date().toLocaleTimeString(); area.textContent += `[${ts}] ${msg}\n`; area.scrollTop = area.scrollHeight; console.log(msg); }
function logError(msg){ log(`错误: ${msg}`); }

/* 格式化 */
function fmt(sec){ if(!sec||sec<=0) return '0秒'; const d=Math.floor(sec/86400), h=Math.floor((sec%86400)/3600), m=Math.floor((sec%3600)/60), s=sec%60; return `${d?d+'天 ':''}${h?h+'小时 ':''}${m?m+'分 ':''}${s}秒`; }

/* BLE 命令 */
function buildCommand(lock) {
    const status = lock ? 0x00 : 0x01;
    const arr = [0xAA, 0x01, status, 0x00];
    const dataView = new DataView(new Uint8Array(arr).buffer);
    return { dataView, hexStr: arr.map(b => b.toString(16).padStart(2, '0')).join(' ').toUpperCase() };
}

/* 远程时间 */
async function getRemoteTime() {
    try {
        const response = await fetch('https://worldtimeapi.org/api/timezone/Etc/UTC');
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        const remote = data.unixtime * 1000;
        timeOffset = Date.now() - remote;
        return remote;
    } catch (e) {
        logError(`时间同步失败: ${e.message}。使用本地时间 + 偏移(${timeOffset}ms)`);
        return Date.now() - timeOffset;
    }
}

/* 防抖保存 */
let saveTimeout;
async function saveState() {
    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(async () => {
        const state = { lockStatus, total, remaining, targetEnd, hideMode, viewUsed, batteryLevel, maxUnlockCount, usedUnlockCount, intervalDays, lastUnlockTime, lockStartTime, savedAt: await getRemoteTime() };
        try {
            const response = await fetch(WORKER_API_URL, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(state) });
            if (!response.ok) throw new Error(await response.text() || response.statusText);
            console.log('状态已保存到 Worker KV');
        } catch (e) { logError(`状态保存失败: ${e.message}`); }
    }, 3000);
}

/* 加载状态 */
async function loadState() {
    try {
        const response = await fetch(WORKER_API_URL);
        if (!response.ok) return false;
        const s = await response.json();
        if (!s || (s.lockStatus === 'unlocked' && s.total === 0)) return false;

        Object.assign(window, {
            lockStatus: s.lockStatus || 'unlocked',
            total: s.total || 0,
            hideMode: !!s.hideMode,
            viewUsed: !!s.viewUsed,
            batteryLevel: s.batteryLevel || 85,
            maxUnlockCount: s.maxUnlockCount || 0,
            usedUnlockCount: s.usedUnlockCount || 0,
            intervalDays: s.intervalDays || 0,
            lastUnlockTime: s.lastUnlockTime || 0,
            lockStartTime: s.lockStartTime || 0,
            targetEnd: s.targetEnd || null
        });

        if (s.targetEnd) {
            const now = await getRemoteTime();
            remaining = Math.max(0, Math.floor((s.targetEnd - now) / 1000));
            if (remaining > 0 && (lockStatus.startsWith('locked') || lockStatus === 'unlocked_temp')) {
                startCountdown(remaining, { resume: true });
            } else {
                resetLockState();
            }
        }
        log('状态从 Worker KV 恢复');
        return true;
    } catch (e) {
        logError(`状态加载失败: ${e.message}`);
        return false;
    }
}

function resetLockState() {
    lockStatus = 'unlocked'; total = 0; remaining = 0; targetEnd = null;
    usedUnlockCount = 0; maxUnlockCount = 0; intervalDays = 0; lastUnlockTime = 0; lockStartTime = 0;
    hideMode = false; viewUsed = false;
}

/* 本地倒计时 */
async function startCountdown(seconds, options = {}) {
    const sec = Math.max(MIN_SECONDS, Math.min(MAX_SECONDS, seconds));
    total = sec; remaining = sec;
    lockStatus = 'locked_timer';
    hideMode = !!options.hide;
    viewUsed = false;

    const nowRemote = await getRemoteTime();
    if (!options.resume) {
        usedUnlockCount = 0; lastUnlockTime = 0; lockStartTime = nowRemote;
    }
    remoteTarget = nowRemote + remaining * 1000;
    localStart = Date.now();

    if (!options.resume) {
        const { dataView } = buildCommand(true);
        BleManager.sendData(dataView, '定时锁启动 (4 字节)');
        showToast('定时锁定成功', hideMode ? '剩余时间已隐藏' : `时长: ${fmt(sec)}`, false);
    }

    if (timerId) clearInterval(timerId);
    timerId = setInterval(() => {
        const nowLocal = Date.now();
        remaining = Math.max(0, Math.floor((remoteTarget - (nowLocal - timeOffset)) / 1000));
        if (remaining <= 0) {
            clearInterval(timerId); timerId = null;
            lockStatus = 'unlocked'; lockStartTime = 0;
            const { dataView } = buildCommand(false);
            BleManager.sendData(dataView, '自动解锁 (4 字节)');
            showToast('倒计时结束', '设备已自动解锁', false);
            saveState();
        }
        updateUI();
    }, 1000);

    setInterval(async () => {
        const realElapsed = await getRemoteTime() - (remoteTarget - sec * 1000);
        const localElapsed = Date.now() - localStart;
        const drift = localElapsed - realElapsed;
        if (Math.abs(drift) > 5000) {
            log(`时间漂移校准: ${drift.toFixed(0)}ms`);
            localStart = Date.now() - realElapsed;
        }
    }, 60000);
}

/* UI 更新 */
async function updateUI() {
    const connState = connected ? '已连接' : (BleManager.device ? '断开' : '未连接');
    $('connStatus').textContent = connState;
    $('connectBtn').textContent = connected ? '断开连接' : '连接设备';
    
    let lockStatusText = '未上锁';
    let isTimerMode = lockStatus === 'locked_timer';
    let isTempUnlocked = lockStatus === 'unlocked_temp';
    const hasUnlockPermission = maxUnlockCount > 0;

    if (lockStatus === 'locked_manual') {
        lockStatusText = '手动上锁';
    } else if (isTimerMode || isTempUnlocked) {
        const unlockLeft = maxUnlockCount - usedUnlockCount;
        lockStatusText = isTempUnlocked ? '临时解锁' : (hideMode ? '定时（隐藏）' : '定时锁定');
        if (maxUnlockCount > 0 && !hideMode) {
            lockStatusText += ` (${Math.max(0, unlockLeft)}/${maxUnlockCount} 次)`;
        }
    }
    $('lockStatusDisplay').textContent = lockStatusText;

    $('countShort').textContent = `${batteryLevel}%`;
    
    let targetTimeDisplay = targetEnd ? new Date(targetEnd).toLocaleString() : '-';
    if ((lockStatus === 'locked_timer' || lockStatus === 'unlocked_temp') && hideMode) {
        targetTimeDisplay = '已隐藏';
    }
    $('targetTime').textContent = targetTimeDisplay;
    
    let remainingDisplay = getRemainingDisplayText();
    
    const circle = $('lockCircle'), title = $('circleTitle'), sub = $('circleSub');
    circle.classList.remove('locked_timer', 'locked_manual', 'flash-success', 'flash-fail'); 

    if (isTimerMode || isTempUnlocked) {
        const ratio = total > 0 ? Math.max(0, Math.min(1, remaining / total)) : 0;
        const deg = ratio * 360;
        circle.style.background = `conic-gradient(var(--accent-2) ${deg}deg, #2a2a30 0deg)`;
        circle.classList.add('locked_timer');

        title.textContent = isTempUnlocked ? 
            (hideMode ? '临时解锁中（计时隐藏）' : '临时解锁中') : 
            (hideMode ? '定时中（隐藏）' : '定时中');

        const unlockLeft = maxUnlockCount - usedUnlockCount;
        let subText;
        if (hideMode) {
             subText = isTempUnlocked ? '计时隐藏中，点击圆环可重锁' : (viewUsed ? '已查看（查看功能已用）' : '点击圆环可查看 (1 次)');
             circle.title = isTempUnlocked ? '点击重锁' : '点击查看剩余时间'; 
        } else {
             subText = remainingDisplay;
             if (maxUnlockCount > 0) {
                 const dayStr = intervalDays > 0 ? ` (≥${intervalDays}天)` : '';
                 subText += (subText !== '-') ? ` - 剩 ${Math.max(0, unlockLeft)} 次${dayStr}` : `剩余 ${Math.max(0, unlockLeft)} 次${dayStr}`;
             }
             circle.title = isTempUnlocked ? '点击重锁' : 
                            (hasUnlockPermission ? `点击中途解锁 (剩 ${Math.max(0, unlockLeft)} 次)` : '定时锁定中');
        }
        sub.textContent = subText;

    } else if (lockStatus === 'locked_manual') {
        circle.style.background = 'conic-gradient(var(--accent) 360deg, #2a2a30 0deg)';
        title.textContent = '手动锁定';
        sub.textContent = '点击解锁';
        circle.classList.add('locked_manual');
        circle.title = '点击解锁';
    } else {
        circle.style.background = 'conic-gradient(var(--accent-2) 0deg, #2a2a30 0deg)';
        title.textContent = connected ? '已连接' : '未上锁';
        sub.textContent = '点击上锁';
        circle.title = '点击上锁';
    }

    $('remainingText').textContent = remainingDisplay;
    $('guessBtn').style.display = (isTimerMode && hideMode) ? 'inline-block' : 'none';

    if ((isTimerMode || isTempUnlocked) && hasUnlockPermission) {
        midUnlockBtn.style.display = 'inline-block';
        const unlockLeft = maxUnlockCount - usedUnlockCount;
        const nowRemote = await getRemoteTime();
        const daysPassed = (nowRemote - lastUnlockTime) / (1000 * 3600 * 24);
        const intervalOk = intervalDays === 0 || lastUnlockTime === 0 || daysPassed >= intervalDays;
        
        if (unlockLeft <= 0 || !intervalOk) {
            midUnlockBtn.disabled = true;
            midUnlockBtn.textContent = `解锁次数/间隔不足`;
            midUnlockBtn.style.background = '#444';
        } else {
            midUnlockBtn.disabled = false;
            midUnlockBtn.textContent = hideMode ? `中途解锁` : `中途解锁 (${Math.max(0, unlockLeft)}/${maxUnlockCount})`;
            midUnlockBtn.style.background = '#ff8c42';
        }
    } else {
        midUnlockBtn.style.display = 'none';
    }

    $('lockDay').textContent = await getLockDayForAI();
}

/* 剩余时间显示 */
function getRemainingDisplayText() {
    if (lockStatus === 'locked_timer' || lockStatus === 'unlocked_temp') {
        if (hideMode) return '已隐藏 (猜/看)'; 
        return fmt(remaining);
    }
    return '-';
}

/* AI 天数 */
async function getLockDayForAI() {
    if (!lockStartTime || !(lockStatus.startsWith('locked') || lockStatus === 'unlocked_temp')) return 0;
    const nowRemote = await getRemoteTime();
    const durationMs = nowRemote - lockStartTime;
    const days = Math.ceil(durationMs / (1000 * 60 * 60 * 24));
    return Math.max(1, days);
}

/* AI 控制时长 */
async function adjustTimeByAI(percentage, isIncrease) {
    if (lockStatus !== 'locked_timer') {
        logError('AI 无法控制：未处于定时锁定状态。');
        showToast('AI 控制失败', '未处于定时锁定状态', true);
        return;
    }
    
    const delta = Math.floor(remaining * (percentage / 100));
    const action = isIncrease ? '增加' : '减少';
    const sign = isIncrease ? '+' : '-';
    
    if (isIncrease) {
        remaining = Math.min(remaining + delta, MAX_SECONDS);
    } else {
        remaining = Math.max(remaining - delta, MIN_SECONDS);
    }
    
    const nowRemote = await getRemoteTime();
    remoteTarget = nowRemote + remaining * 1000;
    
    const { dataView } = buildCommand(true);
    BleManager.sendData(dataView, `AI ${action}定时 (${percentage}%)`);
    
    showToast(`AI 惩罚/奖励`, `${action} ${percentage}% (${sign}${fmt(delta)})，时间已更新`, !isIncrease);
    log(`AI ${action} ${percentage}% (${sign}${fmt(delta)})，新剩余 ${fmt(remaining)}`);
    updateUI();
    saveState();
}

/* 中途解锁 */
async function executeMidUnlock() {
    if (!connected) {
        showToast('设备未连接', '请先连接设备', true);
        return;
    }
    lockStatus = 'unlocked_temp';
    usedUnlockCount++;
    lastUnlockTime = await getRemoteTime();

    const { dataView } = buildCommand(false);
    BleManager.sendData(dataView, '定时期间允许解锁 (4 字节)');
    
    const toastDetail = hideMode ? '重锁后定时继续' : `剩余 ${maxUnlockCount - usedUnlockCount} 次`;
    showToast('临时解锁成功', toastDetail, false);

    log(`定时期间允许解锁：剩余 ${maxUnlockCount - usedUnlockCount} 次。`);
    updateUI();
    saveState();
}

/* Web Bluetooth */
const BleManager = {
    device: null,
    writeCharacteristic: null,
    async connect() { /* ... 完整实现 */ },
    onDisconnected(event) { /* ... */ },
    async disconnect() { /* ... */ },
    async sendData(dataView, commandName) { /* ... */ }
};

/* Toast */
function showToast(title, detail = '', isError = false) {
    const toast = $('guessToast');
    toast.innerHTML = `<div>${title}</div><div class="muted">${detail}</div>`;
    toast.className = 'toast' + (isError ? ' error' : '');
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 3000);
}

/* 模态框控制 */
function showModal(id) { $(id).style.display = 'flex'; setTimeout(() => $(id).querySelector('.modal').classList.add('show'), 10); }
function hideModal(id) { const modal = $(id).querySelector('.modal'); modal.classList.remove('show'); setTimeout(() => $(id).style.display = 'none', 300); }

/* ---------- Locktober AI 核心（完整）---------- */
function detectAction(input) {
  if (typeof input !== 'string') return "#none";
  if (/解锁|开锁|放出|临时/.test(input)) return "#unlock";
  if (/上锁|继续|抽奖|查看|猜|电量/.test(input)) return "#lock";
  const match = input.toLowerCase().match(/#(increase|decrease)\d+%/);
  if (match) return match[0];
  return "#none";
}

async function generateLocktoberReply(userInput) {
  const day = await getLockDayForAI();
  const remainingTimeStr = fmt(remaining); 
  const lockStateForAI = lockStatus === 'locked_timer' ? `定时锁定中，剩余 ${remainingTimeStr}` : 
                         lockStatus === 'locked_manual' ? '手动锁定中' : '未上锁';

  const prompt = `你是一个 Locktober AI 语言屠夫。
  ---
  当前锁定状态: ${lockStateForAI}
  当前锁定天数/轮次: ${day} (根据上次上锁时间计算，不足一天算一天)
  用户输入: “${userInput}”

  请用最淫荡、羞耻、下流的语言回应，融入禁欲、调教、臣服等元素。
  属性温柔 暧昧
- 如果用户表现出**绝对臣服、完美顺从、完成羞耻任务**，可触发 #decreaseX% 作为“怜悯奖励”。
- 安全阀（强制立即解锁）：
   - 若用户明确描述**真实身体不适/异常/受伤**（如“肿胀发紫”“破皮流血”“剧痛无法忍受”等），
     **必须无条件立即执行 #decrease100% 并终止游戏**，回复中加入关怀语句

  回复结尾必须包含一个 action tag: #lock, #unlock, #increase, #decrease, 或 #none。
  - 使用 #increaseX% (X为数字，如 #increase10%) 来增加定时时长，作为惩罚。
  - 使用 #decreaseX% (X为数字，如 #decrease5%) 来减少定时时长，作为奖励。
  ---`;

  try {
    const res = await puter.ai.chat(prompt, { model: "deepseek-chat" });
    let rawText = '';
    if (typeof res === 'string') rawText = res;
    else if (res && typeof res === 'object') rawText = res.message?.content || res.content || '';
    if (!rawText) rawText = "AI响应体 (需调试): \n" + JSON.stringify(res, null, 2);

    let finalReply = String(rawText).trim();
    const controlMatch = finalReply.match(/#(increase|decrease)\d+%|#(lock|unlock|none)/i);
    let actionTag = '#none';

    if (controlMatch) {
      actionTag = controlMatch[0].toLowerCase();
      finalReply = finalReply.replace(controlMatch[0], '').trim();
    } else {
      actionTag = detectAction(userInput);
    }
    
    return { text: finalReply || '主人～我湿了...', tag: actionTag };

  } catch (e) {
    console.error('AI 错误:', e);
    return { text: `AI 崩溃了！错误: ${e.message || '未知'}`, tag: "#none" };
  }
}

/* AI 消息发送 */
$('aiSendBtn').onclick = async () => {
    const input = $('aiInput');
    const msg = input.value.trim();
    if (!msg) return;
    
    addAIMessage(msg, 'user');
    input.value = '';
    $('aiSendBtn').disabled = true;

    try {
        const { text, tag } = await generateLocktoberReply(msg);
        addAIMessage(text, 'ai');
        $('aiTags').textContent = tag;

        if (tag.startsWith('#increase') || tag.startsWith('#decrease')) {
            const match = tag.match(/#?(increase|decrease)(\d+)%/);
            if (match) {
                const isIncrease = match[1] === 'increase';
                const pct = parseInt(match[2], 10);
                if (pct > 0 && pct <= 100) {
                    await adjustTimeByAI(pct, isIncrease);
                    if (pct === 100 && !isIncrease) {
                        lockStatus = 'unlocked';
                        clearInterval(timerId); timerId = null;
                        const { dataView } = buildCommand(false);
                        BleManager.sendData(dataView, 'AI 安全阀解锁');
                        showToast('紧急解锁', 'AI 检测到身体不适，已强制解锁', true);
                        updateUI();
                        saveState();
                    }
                }
            }
        } else if (tag === '#unlock' && lockStatus === 'locked_timer') {
            await executeMidUnlock();
        } else if (tag === '#lock' && lockStatus === 'unlocked_temp') {
            lockStatus = 'locked_timer';
            const { dataView } = buildCommand(true);
            BleManager.sendData(dataView, 'AI 强制重锁');
            showToast('AI 重锁', '不许逃跑哦～', false);
            updateUI();
            saveState();
        }

    } catch (err) {
        addAIMessage('AI 罢工了... 请稍后再试', 'ai');
        console.error(err);
    } finally {
        $('aiSendBtn').disabled = false;
    }
};

function addAIMessage(text, type) {
    const div = document.createElement('div');
    div.className = `ai-msg ${type}`;
    div.textContent = text;
    $('aiMessages').appendChild(div);
    $('aiMessages').scrollTop = $('aiMessages').scrollHeight;
}

/* AI 浮窗 */
let aiPanelVisible = false;
$('aiFloatBtn').onclick = () => {
    aiPanelVisible = !aiPanelVisible;
    $('aiChatPanel').style.display = aiPanelVisible ? 'flex' : 'none';
};
$('closeAIPanel').onclick = () => { aiPanelVisible = false; $('aiChatPanel').style.display = 'none'; };

/* 初始化 */
async function init() {
    const had = await loadState();
    renderCalendar(); renderSelectors(); renderDateHM();
    if (!had) {
        await updateUI();
        log('v2.5.4 Web BLE 已就绪 — 请点击 "连接设备" 按钮开始。');
    } else {
        await updateUI();
        log('恢复远程存储状态。请重新点击 "连接设备" 按钮连接 BLE 设备。');
    }
}
init();
</script>
</body>
</html>
